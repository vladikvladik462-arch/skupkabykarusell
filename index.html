<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STALKER - Калькулятор скупки МЗ</title>
    <style>
        :root {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2a2a2a;
            --bg-tertiary: #353535;
            --border-color: #4a4a4a;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --text-accent: #ffffff;
            --accent-color: #6a6a6a;
            --success-color: #4CAF50;
            --bonus-color: #FF9800;
            --search-highlight: #ff4444;
            --sale-color: #2196F3;
            --edit-color: #FFA500;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 15px;
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        .app-container.sidebar-open {
            margin-right: 50%;
            transform: translateX(-25%);
        }

        @media (max-width: 1024px) {
            .app-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }
            
            .app-container.sidebar-open {
                margin-right: 80%;
                transform: translateX(-40%);
            }
        }

        .header {
            grid-column: 1 / -1;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 10px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            color: var(--text-accent);
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        .app-navigation {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
            gap: 10px;
        }

        .nav-btn {
            padding: 10px 20px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .nav-btn:hover {
            background: var(--accent-color);
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: var(--accent-color);
            color: var(--text-accent);
        }

        .search-container {
            max-width: 500px;
            margin: 0 auto;
        }

        .search-input {
            width: 100%;
            padding: 10px 15px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .search-input::placeholder {
            color: var(--text-secondary);
        }

        .main-content {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        .category-tabs {
            display: flex;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .category-tab {
            flex: 1;
            padding: 12px;
            background: var(--bg-tertiary);
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
            position: relative;
        }

        .category-tab:hover {
            background: var(--accent-color);
        }

        .category-tab.active {
            background: var(--accent-color);
            color: var(--text-accent);
            font-weight: bold;
        }

        .category-tab.highlighted::after {
            content: '';
            position: absolute;
            top: 3px;
            right: 3px;
            width: 8px;
            height: 8px;
            background: var(--search-highlight);
            border-radius: 50%;
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
            flex: 1;
            overflow-y: auto;
            max-height: 70vh;
            padding: 5px;
        }

        .item-card {
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            transition: all 0.3s ease;
            position: relative;
        }

        .item-card:hover {
            border-color: var(--accent-color);
        }

        .item-card.selected {
            border-color: var(--success-color);
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, #2a3a2a 100%);
        }

        .item-card.search-match {
            border-color: var(--search-highlight);
            box-shadow: 0 0 0 1px var(--search-highlight);
        }

        .item-card.locked {
            opacity: 0.6;
            border-color: #ff4444 !important;
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, #3a2a2a 100%);
        }

        .item-card.locked .quantity-input {
            background: #5a2a2a;
            color: #ff6b6b;
        }

        .lock-indicator {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ff4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
        }

        .item-image {
            width: 100%;
            height: 80px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .item-image img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .item-name {
            font-size: 0.85em;
            margin-bottom: 8px;
            color: var(--text-accent);
            height: 36px;
            overflow: hidden;
            line-height: 1.3;
        }

        .item-price {
            color: var(--success-color);
            font-weight: bold;
            font-size: 1em;
            margin-bottom: 10px;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 5px;
        }

        .quantity-btn {
            width: 28px;
            height: 28px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .quantity-btn:hover {
            background: var(--accent-color);
            transform: scale(1.1);
        }

        .quantity-input {
            width: 50px;
            text-align: center;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-accent);
            border-radius: 4px;
            padding: 4px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .sidebar {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        .control-btn.sale {
            background: #2a3a5a;
            border-color: #3a5a7a;
            color: var(--sale-color);
        }
        
        .control-btn.sale:hover {
            background: #3a5a7a;
        }

        .sale-amount {
            font-size: 1.5em;
            color: var(--sale-color);
            font-weight: bold;
            margin: 5px 0;
        }

        .total-section {
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: center;
        }

        .total-label {
            color: var(--text-secondary);
            font-size: 0.95em;
            margin-bottom: 8px;
        }

        .total-amount {
            font-size: 2.2em;
            color: var(--success-color);
            font-weight: bold;
            margin: 8px 0;
        }

        .bonus-amount {
            font-size: 1.5em;
            color: var(--bonus-color);
            font-weight: bold;
            margin: 5px 0;
        }

        .selected-count {
            color: var(--text-secondary);
            font-size: 0.85em;
        }

        .control-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        .control-btn {
            padding: 12px;
            border: 2px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: var(--accent-color);
            transform: translateY(-2px);
        }

        .control-btn.reset {
            background: #5a2a2a;
            border-color: #7a3a3a;
        }

        .control-btn.reset:hover {
            background: #7a3a3a;
        }

        .control-btn.bonus {
            background: #5a4a2a;
            border-color: #7a6a3a;
            color: var(--bonus-color);
        }

        .control-btn.bonus:hover {
            background: #7a6a3a;
        }

        .control-btn.download {
            background: #2a4a5a;
            border-color: #3a6a7a;
            color: #a0d0ff;
        }

        .control-btn.download:hover {
            background: #3a6a7a;
        }

        .item-details {
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 12px;
            margin-top: auto;
        }

        .detail-title {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .detail-image {
            width: 100%;
            height: 120px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .detail-image img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .detail-name {
            color: var(--text-accent);
            font-size: 1em;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .detail-price {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .detail-total {
            color: var(--success-color);
            font-size: 0.95em;
            font-weight: bold;
        }

        .items-sidebar {
            position: fixed;
            top: 0;
            right: -50%;
            width: 50%;
            height: 100vh;
            background: var(--bg-secondary);
            border-left: 2px solid var(--border-color);
            z-index: 1000;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .items-sidebar.open {
            right: 0;
        }

        .sidebar-header {
            background: var(--bg-tertiary);
            border-bottom: 2px solid var(--border-color);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-header h2 {
            color: var(--text-accent);
            font-size: 1.4em;
        }

        .close-sidebar {
            background: none;
            border: none;
            color: var(--text-accent);
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .close-sidebar:hover {
            background: var(--accent-color);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .selected-items-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .selected-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .selected-item:hover {
            border-color: var(--accent-color);
        }

        .selected-item-info {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .selected-item-name {
            font-size: 0.9em;
            color: var(--text-accent);
            margin-bottom: 4px;
            font-weight: bold;
        }

        .selected-item-price {
            font-size: 0.8em;
            color: var(--text-secondary);
        }

        .selected-item-quantity {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0 10px;
        }

        .selected-item-qty {
            font-size: 1em;
            color: var(--success-color);
            font-weight: bold;
            min-width: 30px;
            text-align: center;
        }

        .selected-item-total {
            font-size: 0.9em;
            color: var(--success-color);
            font-weight: bold;
            min-width: 80px;
            text-align: right;
        }

        .remove-item-btn {
            background: #5a2a2a;
            border: 1px solid #7a3a3a;
            color: #ff6b6b;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 0.8em;
            margin-left: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .empty-selected {
            text-align: center;
            color: var(--text-secondary);
            font-style: italic;
            padding: 40px 20px;
            font-size: 1em;
        }

        .toggle-sidebar-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            color: var(--text-accent);
            border-radius: 8px;
            padding: 10px 15px;
            cursor: pointer;
            font-weight: bold;
            z-index: 999;
            transition: all 0.3s ease;
        }

        .toggle-sidebar-btn:hover {
            background: var(--accent-color);
            transform: translateY(-2px);
        }

        .special-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 30px;
            z-index: 1000;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        .special-message h2 {
            color: var(--text-accent);
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .special-message p {
            color: var(--text-primary);
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .special-message .ps {
            color: var(--text-secondary);
            font-size: 0.8em;
            margin-top: 15px;
            font-style: italic;
        }

        .close-message {
            margin-top: 20px;
            padding: 8px 20px;
            background: var(--accent-color);
            border: none;
            border-radius: 5px;
            color: var(--text-accent);
            cursor: pointer;
            font-weight: bold;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 999;
        }

        .app-page {
            display: none;
            grid-column: 1 / -1;
        }

        .app-page.active {
            display: block;
        }

        .credit-section, .storage-section {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .credit-form, .storage-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 20px;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            color: var(--text-secondary);
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .form-input {
            padding: 10px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            color: var(--text-primary);
        }

        .calculate-btn {
            padding: 12px;
            background: var(--success-color);
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .calculate-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .edit-btn {
            padding: 12px;
            background: var(--edit-color);
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .edit-btn:hover {
            background: #e59400;
            transform: translateY(-2px);
        }

        .credit-result, .storage-result {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
        }

        .credit-total {
            font-size: 2em;
            color: var(--success-color);
            font-weight: bold;
            margin: 10px 0;
        }

        .loans-table, .storage-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .loans-table th, .storage-table th {
            background: var(--bg-tertiary);
            padding: 12px;
            text-align: left;
            color: var(--text-accent);
            border-bottom: 2px solid var(--border-color);
        }

        .loans-table td, .storage-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .loans-table tr:hover, .storage-table tr:hover {
            background: var(--bg-tertiary);
        }

        .delete-btn {
            padding: 6px 12px;
            background: #d32f2f;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            margin-right: 5px;
        }

        .delete-btn:hover {
            background: #b71c1c;
        }

        .edit-storage-btn {
            padding: 6px 12px;
            background: var(--edit-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            margin-right: 5px;
        }

        .edit-storage-btn:hover {
            background: #e59400;
        }

        .storage-grid-container {
            margin: 10px 0;
            min-height: 10px;
            overflow: auto;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            background: var(--bg-tertiary);
        }

        .storage-grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            gap: 3px;
            background: var(--border-color);
            padding: 3px;
            border-radius: 5px;
            width: 100%;
            margin: 0 auto;
        }

        .storage-cell {
            aspect-ratio: 1;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            width: 100%;
            min-height: 25px;
            font-size: 0.7em;
        }

        .storage-cell:hover {
            background: var(--accent-color);
        }

        .storage-cell.occupied {
            background: var(--success-color);
        }

        .storage-cell.selected {
            background: var(--bonus-color);
        }

        .cell-info {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3em;
            color: var(--text-accent);
            text-align: center;
            word-break: break-all;
            padding: 1px;
        }

        .storage-controls {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }

        .storage-control-btn {
            padding: 10px 20px;
            border: 2px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .storage-control-btn:hover {
            background: var(--accent-color);
        }

        .storage-summary {
            background: var(--bg-tertiary);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .edit-form {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border: 2px solid var(--edit-color);
        }

        .safe-selection {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .safe-btn {
            padding: 12px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .safe-btn:hover {
            background: var(--accent-color);
        }

        .safe-btn.active {
            background: var(--accent-color);
            color: var(--text-accent);
            border-color: var(--success-color);
        }

        .edit-controls {
            background: var(--bg-tertiary);
            border: 2px solid var(--edit-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            display: none;
        }

        .edit-controls.active {
            display: block;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }
        
        @media (max-width: 768px) {
            .app-container {
                padding: 5px;
                gap: 10px;
            }

            .header h1 {
                font-size: 1.5em;
            }

            .items-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 8px;
            }

            .category-tabs {
                flex-direction: column;
            }

            .total-amount {
                font-size: 1.8em;
            }
            
            .quantity-btn {
                width: 26px;
                height: 26px;
            }
            
            .quantity-input {
                width: 45px;
                font-size: 0.85em;
            }

            .items-sidebar {
                width: 80%;
                right: -80%;
            }

            .app-container.sidebar-open {
                margin-right: 80%;
                transform: translateX(-40%);
            }

            .app-navigation {
                flex-direction: column;
                align-items: center;
            }

            .storage-grid {
                grid-template-columns: repeat(9, 1fr);
            }

            .credit-form, .storage-form {
                grid-template-columns: 1fr;
            }

            .storage-cell {
                min-height: 20px;
                font-size: 0.6em;
            }

            .safe-selection {
                grid-template-columns: 1fr;
            }

            .storage-grid-container {
                min-height: 10px;
            }
        }

        @media (max-width: 480px) {
            .items-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .item-card {
                padding: 8px;
            }

            .item-image {
                height: 70px;
            }
            
            .quantity-btn {
                width: 24px;
                height: 24px;
                font-size: 0.8em;
            }
            
            .quantity-input {
                width: 40px;
                font-size: 0.8em;
            }

            .items-sidebar {
                width: 90%;
                right: -90%;
            }

            .app-container.sidebar-open {
                margin-right: 90%;
                transform: translateX(-45%);
            }

            .selected-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .selected-item-quantity {
                margin: 0;
                align-self: flex-end;
            }

            .storage-grid {
                grid-template-columns: repeat(9, 1fr);
            }

            .storage-cell {
                min-height: 18px;
                font-size: 0.5em;
            }

            .storage-grid-container {
                min-height: 10px;
            }
        }
    </style>
</head>
<body>
    <button class="toggle-sidebar-btn" onclick="toggleItemsSidebar()">📦 Список предметов</button>

    <div class="app-container" id="appContainer">
        <header class="header">
            <h1>🎯 Калькулятор скупки МЗ</h1>
            <div class="app-navigation">
                <button class="nav-btn active" data-page="calculator">Калькулятор</button>
                <button class="nav-btn" data-page="credit">Кредит</button>
                <button class="nav-btn" data-page="storage">Хранилище</button>
            </div>
            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="Поиск предметов...">
            </div>
        </header>

        <div id="calculatorPage" class="app-page active">
            <main class="main-content">
                <div class="category-tabs">
                    <button class="category-tab active" data-category="scrap">Хлам</button>
                    <button class="category-tab" data-category="garbage">Мусор</button>
                    <button class="category-tab" data-category="medicine">Ингридиенты</button>
                    <button class="category-tab" data-category="mutants">Мутанты</button>
                    <button class="category-tab" data-category="documents">Документы</button>
                    <button class="category-tab" data-category="artifacts">Артефакты</button>
                </div>

                <div id="itemsContainer" class="items-grid">
                </div>
            </main>

            <aside class="sidebar">
                <div class="total-section">
                    <div class="total-label">ОБЩАЯ СУММА</div>
                    <div class="total-amount" id="totalSum">0</div>
                    <div class="bonus-amount" id="bonusSum" style="display: none;">+15%: 0</div>
                    <div class="sale-amount" id="saleSum" style="display: none;">+30%: 0</div>
                    <div class="selected-count" id="selectedCount">Выбрано предметов: 0</div>
                </div>

                <div class="control-buttons">
                    <button class="control-btn reset" onclick="resetAll()">🔄 Сбросить всё</button>
                    <button class="control-btn bonus" onclick="addBonus()">🎁 Добавить 15%</button>
                    <button class="control-btn sale" onclick="addSale()">💰 Продажа</button>
                    <button class="control-btn download" onclick="downloadList()">📥 Скачать список</button>
                </div>

                <div class="item-details">
                    <div class="detail-title">ИНФОРМАЦИЯ О ПРЕДМЕТЕ</div>
                    <div class="detail-image" id="detailImage">
                        <div style="color: var(--text-secondary); text-align: center; font-size: 0.9em;">Выберите предмет</div>
                    </div>
                    <div class="detail-name" id="detailName">-</div>
                    <div class="detail-price" id="detailPrice">Цена: -</div>
                    <div class="detail-total" id="detailTotal">Сумма: -</div>
                </div>
            </aside>
        </div>

        <div id="creditPage" class="app-page">
            <div class="credit-section">
                <h2>💰 Система кредитования</h2>
                
                <div class="credit-form">
                    <div class="form-group">
                        <label>Имя игрока:</label>
                        <input type="text" id="creditPlayerName" class="form-input" placeholder="Введите имя">
                    </div>
                    <div class="form-group">
                        <label>UID игрока:</label>
                        <input type="text" id="creditUID" class="form-input" placeholder="Введите UID">
                    </div>
                    <div class="form-group">
                        <label>Сумма кредита:</label>
                        <input type="number" id="creditAmount" class="form-input" placeholder="Сумма в рублях" min="1">
                    </div>
                    <div class="form-group">
                        <label>Срок (дни):</label>
                        <input type="number" id="creditDays" class="form-input" placeholder="1-30 дней" min="1" max="30">
                    </div>
                    <button class="calculate-btn" onclick="calculateCredit()">Рассчитать кредит</button>
                </div>

                <div class="credit-result" id="creditResult" style="display: none;">
                    <h3>Результат расчета:</h3>
                    <div class="credit-total" id="creditTotal">0 руб.</div>
                    <div id="creditBreakdown"></div>
                    <button class="calculate-btn" onclick="createLoan()" style="margin-top: 15px;">Оформить кредит</button>
                </div>
            </div>

            <div class="credit-section">
                <h2>📊 Текущие кредиты</h2>
                <table class="loans-table">
                    <thead>
                        <tr>
                            <th>Имя</th>
                            <th>UID</th>
                            <th>Сумма</th>
                            <th>Срок</th>
                            <th>Дата взятия</th>
                            <th>Текущий долг</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody id="loansTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <div id="storagePage" class="app-page">
            <div class="storage-section">
                <h2>🏦 Аренда хранилища</h2>
                
                <div class="safe-selection">
                    <button class="safe-btn active" data-safe="1">Сейф 1</button>
                    <button class="safe-btn" data-safe="2">Сейф 2</button>
                    <button class="safe-btn" data-safe="3">Сейф 3</button>
                </div>
                
                <div class="storage-form">
                    <div class="form-group">
                        <label>Имя игрока:</label>
                        <input type="text" id="storagePlayerName" class="form-input" placeholder="Введите имя">
                    </div>
                    <div class="form-group">
                        <label>UID игрока:</label>
                        <input type="text" id="storageUID" class="form-input" placeholder="Введите UID">
                    </div>
                    <div class="form-group">
                        <label>Срок (дни):</label>
                        <input type="number" id="storageDays" class="form-input" placeholder="1-30 дней" min="1" max="30">
                    </div>
                    <div class="form-group">
                        <label>Количество ячеек:</label>
                        <input type="number" id="storageCellsCount" class="form-input" value="1" min="1" max="162" readonly>
                    </div>
                    <button class="calculate-btn" onclick="calculateStorage()">Рассчитать стоимость</button>
                </div>

                <div class="storage-controls">
                    <button class="storage-control-btn" onclick="selectAllCells()">Выбрать все</button>
                    <button class="storage-control-btn" onclick="clearSelection()">Очистить выбор</button>
                </div>

                <div class="storage-grid-container">
                    <h3>Выбор ячеек (9×18 = 162 ячейки) - <span id="currentSafeName">Сейф 1</span></h3>
                    <div class="storage-grid" id="storageGrid">
                    </div>
                </div>

                <div class="storage-summary" id="storageResult" style="display: none;">
                    <h3>Результат расчета:</h3>
                    <div class="credit-total" id="storageTotal">0 руб.</div>
                    <div id="storageBreakdown"></div>
                    <button class="calculate-btn" onclick="createStorageRental()" style="margin-top: 15px;">Оформить аренду</button>
                </div>
            </div>

            <div class="storage-section">
                <h2>📋 Текущие аренды</h2>
                <table class="storage-table">
                    <thead>
                        <tr>
                            <th>Имя</th>
                            <th>UID</th>
                            <th>Срок</th>
                            <th>Ячейки</th>
                            <th>Стоимость</th>
                            <th>Дата начала</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody id="storageTableBody">
                    </tbody>
                </table>
            </div>

            <div class="storage-section" id="editStorageSection" style="display: none;">
                <h2>✏️ Редактирование аренды</h2>
                
                <div class="edit-form" id="editStorageForm">
                    <div class="storage-form">
                        <div class="form-group">
                            <label>Имя игрока:</label>
                            <input type="text" id="editStoragePlayerName" class="form-input">
                        </div>
                        <div class="form-group">
                            <label>UID игрока:</label>
                            <input type="text" id="editStorageUID" class="form-input">
                        </div>
                        <div class="form-group">
                            <label>Срок (дни):</label>
                            <input type="number" id="editStorageDays" class="form-input" min="1" max="30">
                        </div>
                        <div class="form-group">
                            <label>Количество ячеек:</label>
                            <input type="number" id="editStorageCellsCount" class="form-input" value="1" min="1" max="162" readonly>
                        </div>
                    </div>

                    <div class="storage-controls">
                        <button class="storage-control-btn" onclick="selectAllCellsEdit()">Выбрать все</button>
                        <button class="storage-control-btn" onclick="clearSelectionEdit()">Очистить выбор</button>
                    </div>

                    <div class="storage-grid-container">
                        <h3>Выбор ячеек для редактирования</h3>
                        <div class="storage-grid" id="editStorageGrid">
                        </div>
                    </div>

                    <div class="storage-controls">
                        <button class="calculate-btn" onclick="updateStorageRental()">Сохранить изменения</button>
                        <button class="storage-control-btn" onclick="cancelEditStorage()">Отмена</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="items-sidebar" id="itemsSidebar">
        <div class="sidebar-header">
            <h2>📦 ВЫБРАННЫЕ ПРЕДМЕТЫ</h2>
            <button class="close-sidebar" onclick="toggleItemsSidebar()">×</button>
        </div>
        <div class="sidebar-content">
            <div class="selected-items-list" id="selectedItemsList">
                <div class="empty-selected">Нет выбранных предметов</div>
            </div>
        </div>
    </div>

    <div class="edit-controls">
        <div style="text-align: center; margin-bottom: 10px;">
            <strong style="color: var(--edit-color);">⚙️ РЕЖИМ РЕДАКТИРОВАНИЯ</strong>
        </div>
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button class="control-btn" onclick="toggleEditMode()" style="background: #5a2a2a; border-color: #7a3a3a;">❌ Выйти из режима</button>
            <button class="control-btn" onclick="resetAllPrices()" style="background: #5a4a2a; border-color: #7a6a3a;">🗑️ Сбросить все цены</button>
            <button class="control-btn" onclick="unlockAllItems()" style="background: #2a5a2a; border-color: #3a7a3a;">🔓 Разблокировать все</button>
        </div>
        <div style="text-align: center; margin-top: 10px; font-size: 0.8em; color: var(--text-secondary);">
            Для выхода из режима редактирования введите пароль еще раз в поиске
        </div>
    </div>

    <script>
        const itemsDatabase = {
            scrap: [
                {name: "Предохранитель", price: 600.0, image: "images/scrap/fuse.png"},
                {name: "Канифоль", price: 348.0, image: "images/scrap/rosin.jpg"},
                {name: "Текстолит", price: 372.0, image: "images/scrap/textolit.jpg"},
                {name: "Старая батарейка", price: 250.0, image: "images/scrap/battery_old.jpg"},
                {name: "Неисправный дозиметр", price: 300.0, image: "images/scrap/dosimeter.jpg"},
                {name: "проводка", price: 2300.0, image: "images/scrap/wiring.jpg"},
                {name: "Транзисторы", price: 900.0, image: "images/scrap/transistors.jpg"},
                {name: "Конденсаторы", price: 490.0, image: "images/scrap/capacitors.jpg"},
                {name: "Резисторы", price: 800.0, image: "images/scrap/resistors.jpg"},
                {name: "Инструменты грубой работы", price: 700.0, image: "images/scrap/tools.jpg"},
                {name: "Комплект расходников", price: 800.0, image: "images/scrap/consumables.jpg"},
                {name: "Автомобильный аккумулятор", price: 366.0, image: "images/scrap/battery_car.jpg"},
                {name: "Катушка с медью", price: 1800.0, image: "images/scrap/copper_coil.jpg"},
                {name: "Клей ультра", price: 138.0, image: "images/scrap/glue_ultra.jpg"},
                {name: "Клей момент", price: 220.0, image: "images/scrap/glue_moment.jpg"},
                {name: "Полиуретан. клей", price: 198.0, image: "images/scrap/glue_polyurethane.jpg"},
                {name: "прочная нить", price: 87.0, image: "images/scrap/thread.jpg"},
				{name: "Нейлоновая нить", price: 100.0, image: "images/scrap/nylon_thread.jpg"},
                {name: "Сверток кожи", price: 144.0, image: "images/scrap/leather_bundle.jpg"},
                {name: "Прорезиненная ткань", price: 315.0, image: "images/scrap/rubber_fabric.jpg"},
                {name: "Ткань армотекс", price: 199.0, image: "images/scrap/fabric_armotex.jpg"},
                {name: "Армированная ткань", price: 177.0, image: "images/scrap/reinforced_fabric.jpg"},
                {name: "Ткань изофлекс", price: 134.0, image: "images/scrap/fabric_isoflex.jpg"},
                {name: "Ткань гидра 225", price: 112.0, image: "images/scrap/fabric_hydra.jpg"},
                {name: "Ткань из брезента", price: 208.0, image: "images/scrap/fabric_tarpaulin.jpg"},
                {name: "Клейкая лента - герметик", price: 80.0, image: "images/scrap/tape_sealant.jpg"},
                {name: "Термостойкая клейкая лента", price: 80.0, image: "images/scrap/tape_heat.jpg"},
                {name: "Клеевая лента", price: 98.0, image: "images/scrap/tape_glue.jpg"},
                {name: "Армированная клейкая лента", price: 132.0, image: "images/scrap/tape_reinforced.jpg"},
                {name: "Особопрочная клейкая лента", price: 140.0, image: "images/scrap/tape_strong.jpg"},
                {name: "Диэлектрическая лента", price: 80.0, image: "images/scrap/tape_dielectric.jpg"},
				{name: "Изолента", price: 224.0, image: "images/scrap/tape.jpg"},
                {name: "Разводной ключ", price: 200.0, image: "images/scrap/wrench.png"},
				{name: "Гаечный ключ", price: 125.0, image: "images/scrap/key.png"},
                {name: "Клещи", price: 200.0, image: "images/scrap/pliers.jpg"},
                {name: "Молоток", price: 125.0, image: "images/scrap/hammer.jpg"},
                {name: "Отвертка", price: 125.0, image: "images/scrap/screwdriver.jpg"},
                {name: "Швейцарский нож", price: 175.0, image: "images/scrap/swiss_knife.png"},
                {name: "скальпель", price: 200.0, image: "images/scrap/skalpel.jpg"},
                {name: "мультитул", price: 270.0, image: "images/scrap/multitool.jpg"},
                {name: "Огнеупорное полотно", price: 180.0, image: "images/scrap/fireproof_cloth.jpg"},
                {name: "Заводские детали", price: 900.0, image: "images/scrap/facrory_parts.jpg"},
                {name: "Старая экипировка", price: 400.0, image: "images/scrap/old_equipment.jpg"},
                {name: "Мотки паракорда", price: 665.0, image: "images/scrap/paracord.jpg"},
                {name: "Старые инструменты", price: 380.0, image: "images/scrap/old_tools.jpg"},
                {name: "Защита 1 класса", price: 640.0, image: "images/scrap/protection_1.jpg"},
                {name: "Боковая полимерная брониплита", price: 780.0, image: "images/scrap/armor_side_polymer.jpg"},
                {name: "полимерная брониплита", price: 780.0, image: "images/scrap/armor_polymer.jpg"},
                {name: "Брониплита 3 класса", price: 1200.0, image: "images/scrap/armor_3.jpg"},
                {name: "Боковая брониплита 3 класса", price: 1100.0, image: "images/scrap/armor_side_3.jpg"},
                {name: "Платы", price: 4800.0, image: "images/scrap/boards.jpg"},
                {name: "Электромагниты", price: 3600.0, image: "images/scrap/elecrtomagnets.jpg"},
				{name: "Легкий набор укрепления костюма", price: 1150.0, image: "images/scrap/suit_reinforcement_kit.png"},
				{name: "Легкий набор подсумков", price: 1200.0, image: "images/scrap/pouch_kit.png"},
				{name: "Легкий набор СИЗ", price: 1400.0, image: "images/scrap/ppe_kit.png"}
            ],
            mutants: [
                {name: "Копыто кабана", price: 134.0, image: "images/mutants/boar_hoof.png"},
                {name: "Клыки кабана", price: 179.0, image: "images/mutants/boar_tusks.png"},
                {name: "Шкура кабана", price: 72.0, image: "images/mutants/boar_skin.png"},
                {name: "Нос слепого пса", price: 154.0, image: "images/mutants/blind_dog_nose.png"},
                {name: "Хвост слепого пса", price: 99.0, image: "images/mutants/blind_dog_tail.png"},
                {name: "Шкура слепого пса", price: 70.0, image: "images/mutants/blind_dog_skin.png"},
                {name: "Челюсть псевдособаки", price: 254.0, image: "images/mutants/pseudodog_jaw.png"},
                {name: "Хвост псевдособаки", price: 155.0, image: "images/mutants/pseudodog_tail.png"},
                {name: "Шкура псевдособаки", price: 70.0, image: "images/mutants/pseudodog_skin.png"},
                {name: "Хвост пси-собаки", price: 179.0, image: "images/mutants/psidog_tail.png"},
                {name: "Мозг пси-собаки", price: 299.0, image: "images/mutants/psidog_brain.png"},
                {name: "Шкура пси-собаки", price: 76.0, image: "images/mutants/psidog_skin.png"},
                {name: "Глаз плоти", price: 199.0, image: "images/mutants/flesh_eye.png"},
                {name: "Клешня плоти", price: 111.0, image: "images/mutants/flesh_claw.png"},
                {name: "Шкура плоти", price: 66.0, image: "images/mutants/flesh_skin.png"},
                {name: "Голова тушкана", price: 112.0, image: "images/mutants/tushkano_head.png"},
                {name: "Хвост тушкана", price: 86.0, image: "images/mutants/tushkano_tail.png"},
                {name: "Шкура тушкана", price: 40.0, image: "images/mutants/tushkano_skin.png"},
                {name: "Стопа снорка", price: 399.0, image: "images/mutants/snork_foot.png"},
                {name: "Рука снорка", price: 220.0, image: "images/mutants/snork_hand.png"},
                {name: "Хребет снорка", price: 170.0, image: "images/mutants/snork_spine.png"},
                {name: "Щупальца кровососа", price: 300.0, image: "images/mutants/bloodsucker_tentacles.png"},
                {name: "Пальцы кровососа", price: 554.0, image: "images/mutants/bloodsucker_fingers.png"},
                {name: "Шкура кровососа", price: 199.0, image: "images/mutants/bloodsucker_skin.png"},
                {name: "Печень зомби", price: 278.0, image: "images/mutants/zombie_liver.png"},
                {name: "Рука зомби", price: 199.0, image: "images/mutants/zombie_hand.png"},
                {name: "Скальп зомби", price: 80.0, image: "images/mutants/zombie_scalp.png"},
                {name: "Стопа излома", price: 333.0, image: "images/mutants/fracture_foot.png"},
                {name: "Рука излома", price: 266.0, image: "images/mutants/fracture_hand.png"},
                {name: "Кожа излома", price: 98.0, image: "images/mutants/fracture_skin.png"},
                {name: "Лапа горбуна", price: 375.0, image: "images/mutants/hunchback_paw.png"},
                {name: "Голова горбуна", price: 250.0, image: "images/mutants/hunchback_head.png"},
                {name: "Шкура горбуна", price: 108.0, image: "images/mutants/hunchback_skin.png"},
                {name: "Рука карлика", price: 221.0, image: "images/mutants/dwarf_hand.png"},
                {name: "Шкура карлика", price: 98.0, image: "images/mutants/dwarf_skin.png"},
                {name: "Голова карлика", price: 875.0, image: "images/mutants/dwarf_head.png"},
                {name: "Когти химеры", price: 1512.0, image: "images/mutants/chimera_claws.png"},
                {name: "Ухо химеры", price: 1918.0, image: "images/mutants/chimera_ear.png"},
                {name: "Шкура химеры", price: 625.0, image: "images/mutants/chimera_skin.png"},
                {name: "Глаз псевдо-гиганта", price: 2900.0, image: "images/mutants/pseudogiant_eye.png"},
                {name: "Лапа псевдогиганта", price: 1978.0, image: "images/mutants/pseudogiant_paw.png"},
                {name: "Шкура псевдогиганта", price: 900.0, image: "images/mutants/pseudogiant_skin.png"},
                {name: "Рука бюрера", price: 415.0, image: "images/mutants/burer_hand.png"},
                {name: "Мозг бюрера", price: 716.0, image: "images/mutants/burer_brain.png"},
                {name: "Кожа бюрера", price: 198.0, image: "images/mutants/burer_skin.png"},
                {name: "Хвост кота - баюна", price: 312.0, image: "images/mutants/cat_bayun_tail.png"},
                {name: "Железа кота - баюна", price: 212.0, image: "images/mutants/cat_bayun_gland.png"},
                {name: "Шкура кота - баюна", price: 90.0, image: "images/mutants/cat_bayun_skin.png"},
                {name: "Мозг контроллера", price: 933.0, image: "images/mutants/controller_brain.png"},
                {name: "Рука контроллера", price: 572.0, image: "images/mutants/controller_hand.png"},
                {name: "Скальп контроллера", price: 202.0, image: "images/mutants/controller_scalp.png"}
            ],
            documents: [
                {name: "Старая флешка", price: 190.0, image: "images/documents/flash_old.png"},
                {name: "Потертая флешка", price: 330.0, image: "images/documents/flash_worn.png"},
                {name: "Утерянный КПК", price: 350.0, image: "images/documents/pda_lost.png"},
                {name: "Карта ЧЗО 2003г.", price: 444.0, image: "images/documents/map_chzo.png"},
                {name: "Административные документы", price: 580.0, image: "images/documents/admin_docs.png"},
                {name: "Письмо о поставках изделия №62", price: 715.0, image: "images/documents/letter_supply.png"},
                {name: "Документация по изделию №62", price: 2425.0, image: "images/documents/docs_product62.png"},
                {name: "Документы из припяти", price: 532.0, image: "images/documents/docs_pripyat.png"},
                {name: "Приказ №562", price: 502.0, image: "images/documents/order_562.png"},
                {name: "Внутренне распоряжение №423", price: 513.0, image: "images/documents/internal_order.png"},
                {name: "Бумага с записями", price: 200.0, image: "images/documents/paper_notes.png"},
                {name: "Инструкция к изделию №62", price: 2718.0, image: "images/documents/instruction_62.png"},
                {name: "Документы об исследованиях", price: 1486.0, image: "images/documents/research_docs.png"},
                {name: "Сканер Гродус", price: 1500.0, image: "images/documents/scanner_grodus.png"},
                {name: "Сканер Брокс", price: 2200.0, image: "images/documents/scanner_brox.png"},
                {name: "Документы из лаборатории х16", price: 1624.0, image: "images/documents/docs_lab_x16.png"},
                {name: "График поставок", price: 884.0, image: "images/documents/supply_schedule.png"},
                {name: "Излучатель Радуга - основные ТТХ", price: 2130.0, image: "images/documents/emitter_rainbow.png"},
                {name: "Журнал дежурной смены", price: 315.0, image: "images/documents/duty_log.png"},
                {name: "Документы из Х18", price: 1513.0, image: "images/documents/docs_x18.png"},
                {name: "Ноутбук", price: 512.0, image: "images/documents/laptop.png"},
                {name: "Папка с приказом", price: 486.0, image: "images/documents/folder_order.png"},
                {name: "Распоряжение о переводе", price: 614.0, image: "images/documents/transfer_order.png"},
                {name: "Доклад об исследовании образцов", price: 1102.0, image: "images/documents/report_samples.png"},
                {name: "Чертежная бумага", price: 500.0, image: "images/documents/drawing_paper.png"},
                {name: "Фрагмент типографической карта", price: 1181.0, image: "images/documents/map_fragment.png"},
                {name: "Тетрадь с записью об эксперементе", price: 2214.0, image: "images/documents/notebook_experiment.png"}
            ],
            artifacts: [
                {name: "Пустышка", price: 980.0, image: "images/artifacts/dummy.png"},
                {name: "Медуза", price: 3000.0, image: "images/artifacts/jellyfish.png"},
                {name: "Колючка", price: 2160.0, image: "images/artifacts/thorn.png"},
                {name: "Пузырь", price: 3485.0, image: "images/artifacts/bubble.png"},
                {name: "Мамины бусы", price: 1515.0, image: "images/artifacts/mama_beads.png"},
                {name: "Ломоть мяса", price: 1765.0, image: "images/artifacts/meat_slice.png"},
                {name: "Пленка", price: 3200.0, image: "images/artifacts/film.png"},
                {name: "Капли", price: 580.0, image: "images/artifacts/drops.png"},
                {name: "Лунный свет", price: 2415.0, image: "images/artifacts/moonlight.png"},
                {name: "Вспышка", price: 3460.0, image: "images/artifacts/flash.png"},
                {name: "Батарейка", price: 4000.0, image: "images/artifacts/battery.png"},
                {name: "Каменный цветок", price: 3980.0, image: "images/artifacts/stone_flower.png"},
                {name: "Сварка", price: 1817.0, image: "images/artifacts/welding.png"},
                {name: "Колобок", price: 3800.0, image: "images/artifacts/kolobok.png"},
                {name: "Гниль", price: 980.0, image: "images/artifacts/rot.png"},
                {name: "Багрянец", price: 2600.0, image: "images/artifacts/crimson.png"},
                {name: "Пламя", price: 4200.0, image: "images/artifacts/flame.png"},
                {name: "Душа", price: 4900.0, image: "images/artifacts/soul.png"},
                {name: "Глаз", price: 2350.0, image: "images/artifacts/eye.png"},
                {name: "Кварц", price: 2250.0, image: "images/artifacts/quartz.png"},
                {name: "Перекати-поле", price: 1150.0, image: "images/artifacts/tumbleweed.png"},
                {name: "НЛО", price: 4200.0, image: "images/artifacts/ufo.png"},
                {name: "Шаровая молния", price: 3568.0, image: "images/artifacts/ball_lightning.png"},
                {name: "Капля яда", price: 5900.0, image: "images/artifacts/poison_drop.png"},
                {name: "Имбирь", price: 2212.0, image: "images/artifacts/ginger.png"},
                {name: "Отбойник", price: 2880.0, image: "images/artifacts/bumper.png"},
                {name: "Синтез", price: 2650.0, image: "images/artifacts/synthesis.png"},
                {name: "Браслет", price: 4500.0, image: "images/artifacts/bracelet.png"},
                {name: "Ночник", price: 7000.0, image: "images/artifacts/night_light.png"},
                {name: "Мох", price: 2508.0, image: "images/artifacts/moss.png"},
                {name: "Дьяволистник", price: 6045.0, image: "images/artifacts/devils_leaf.png"},
                {name: "Осмий", price: 1645.0, image: "images/artifacts/osmium.png"},
                {name: "Электролит", price: 5435.0, image: "images/artifacts/electrolyte.png"},
                {name: "Самородок", price: 6450.0, image: "images/artifacts/nugget.png"},
                {name: "Янтарь", price: 13560.0, image: "images/artifacts/amber.png"},
                {name: "Червь", price: 4345.0, image: "images/artifacts/worm.png"},
                {name: "Разряд", price: 10000.0, image: "images/artifacts/discharge.png"},
                {name: "Колесо", price: 895.0, image: "images/artifacts/wheel.png"},
                {name: "Лайм", price: 12550.0, image: "images/artifacts/lime.png"},
                {name: "Нос", price: 1670.0, image: "images/artifacts/nose.png"},
                {name: "Лава", price: 3450.0, image: "images/artifacts/lava.png"},
                {name: "Соль", price: 900.0, image: "images/artifacts/salt.png"},
                {name: "Вий", price: 7135.0, image: "images/artifacts/vii.png"},
                {name: "Кислота", price: 4550.0, image: "images/artifacts/acid.png"},
                {name: "Устрица", price: 12100.0, image: "images/artifacts/oyster.png"},
                {name: "Мясорубка", price: 13800.0, image: "images/artifacts/meat_grinder.png"},
                {name: "Болид", price: 4678.0, image: "images/artifacts/bolide.png"},
                {name: "Земля", price: 1700.0, image: "images/artifacts/earth.jpg"},
                {name: "Пепелац", price: 8140.0, image: "images/artifacts/pelengator.png"},
                {name: "Тесла", price: 5050.0, image: "images/artifacts/tesla.png"},
                {name: "Спутник", price: 2440.0, image: "images/artifacts/satellite.png"},
                {name: "Метеор", price: 4789.0, image: "images/artifacts/meteor.png"},
                {name: "Стекло", price: 5000.0, image: "images/artifacts/glass.png"},
                {name: "Пустота", price: 13333.0, image: "images/artifacts/void.png"},
                {name: "Филосовский камень", price: 440.0, image: "images/artifacts/philosophers_stone.png"},
                {name: "Базальт", price: 5555.0, image: "images/artifacts/basalt.png"},
                {name: "Гантеля", price: 6665.0, image: "images/artifacts/dumbbell.png"},
                {name: "Морской ёж", price: 2900.0, image: "images/artifacts/sea_urchin.png"},
                {name: "Центрифуга", price: 3876.0, image: "images/artifacts/centrifuge.png"},
                {name: "Фарш", price: 1100.0, image: "images/artifacts/minced_meat.png"},
                {name: "Магма", price: 6250.0, image: "images/artifacts/magma.png"},
                {name: "Ребус", price: 1942.0, image: "images/artifacts/rebus.png"},
                {name: "Болотник", price: 1500.0, image: "images/artifacts/swamp.png"},
                {name: "Ребра", price: 760.0, image: "images/artifacts/ribs.png"},
                {name: "Игольник", price: 1717.0, image: "images/artifacts/needle_case.png"},
                {name: "Серафим", price: 13900.0, image: "images/artifacts/seraphim.png"},
                {name: "Горгона", price: 1915.0, image: "images/artifacts/gorgon.png"},
                {name: "Коралл", price: 550.0, image: "images/artifacts/coral.png"},
                {name: "Светляк", price: 6140.0, image: "images/artifacts/firefly.png"},
                {name: "Нервы", price: 4000.0, image: "images/artifacts/nerves.png"},
                {name: "Опал", price: 6150.0, image: "images/artifacts/opal.png"},
                {name: "Взрыв", price: 7150.0, image: "images/artifacts/explosion.png"},
                {name: "Пресс", price: 8765.0, image: "images/artifacts/press.png"},
                {name: "Деликатес", price: 4567.0, image: "images/artifacts/delicacy.png"},
                {name: "Бенгальский огонь", price: 1650.0, image: "images/artifacts/sparkler.png"},
                {name: "Каменный ангел", price: 9050.0, image: "images/artifacts/stone_angel.png"},
                {name: "Паук", price: 9050.0, image: "images/artifacts/spider.png"},
                {name: "Уран", price: 1950.0, image: "images/artifacts/uranium.png"},
                {name: "Азотный шар", price: 9356.0, image: "images/artifacts/nitrogen_ball.png"},
                {name: "Аккумулятор", price: 800.0, image: "images/artifacts/accumulator.png"},
                {name: "Гротекс", price: 2870.0, image: "images/artifacts/grotex.png"},
                {name: "Сияние", price: 6670.0, image: "images/artifacts/glow.png"},
                {name: "Иштар", price: 6074.0, image: "images/artifacts/ishtar.png"},
                {name: "Соты", price: 8870.0, image: "images/artifacts/honeycomb.png"},
                {name: "Цеп", price: 750.0, image: "images/artifacts/chain.png"},
                {name: "Палантир", price: 9340.0, image: "images/artifacts/palantir.png"},
                {name: "Рачьи глаза", price: 650.0, image: "images/artifacts/crab_eyes.png"},
                {name: "Мохито", price: 4967.0, image: "images/artifacts/mojito.png"},
                {name: "Сетка", price: 3707.0, image: "images/artifacts/mesh.png"},
                {name: "Изумруд", price: 5767.0, image: "images/artifacts/emerald.png"},
                {name: "Корона", price: 7000.0, image: "images/artifacts/crown.png"},
                {name: "Морок", price: 1760.0, image: "images/artifacts/fog.png"},
                {name: "Серп", price: 5085.0, image: "images/artifacts/sickle.png"},
                {name: "Клевер", price: 4104.0, image: "images/artifacts/clover.png"},
                {name: "Серома", price: 4480.0, image: "images/artifacts/seroma.png"},
                {name: "Пружина", price: 1650.0, image: "images/artifacts/spring.png"},
                {name: "Желчь", price: 1787.0, image: "images/artifacts/bile.png"},
                {name: "Петуния", price: 4235.0, image: "images/artifacts/petunia.png"},
                {name: "фульгурит", price: 1000.0, image: "images/artifacts/fulgurite.png"},
                {name: "Мираж", price: 1760.0, image: "images/artifacts/mirage.png"},
                {name: "Финики", price: 2000.0, image: "images/artifacts/dates.png"},
                {name: "Мрамор", price: 3100.0, image: "images/artifacts/marble.png"},
                {name: "Кровь Камня", price: 500.0, image: "images/artifacts/stone_blood.png"},
                {name: "Сувенир", price: 6050.0, image: "images/artifacts/souvenir.png"},
                {name: "Водоворот", price: 2350.0, image: "images/artifacts/whirlpool.png"},
                {name: "Парадокс", price: 3050.0, image: "images/artifacts/paradox.png"},
                {name: "Угасшая звезда", price: 3100.0, image: "images/artifacts/faded_star.png"},
                {name: "Грави", price: 2402.0, image: "images/artifacts/gravi.png"},
                {name: "Демантоид", price: 3870.0, image: "images/artifacts/demantoid.png"},
                {name: "Огненный шар", price: 1650.0, image: "images/artifacts/fireball.png"},
                {name: "Репейник", price: 700.0, image: "images/artifacts/burdock.png"},
                {name: "Кристалл", price: 3705.0, image: "images/artifacts/crystal.png"},
                {name: "Тиски", price: 4460.0, image: "images/artifacts/vise.png"},
                {name: "Осколюк", price: 3650.0, image: "images/artifacts/fragment.png"},
                {name: "Колье", price: 13200.0, image: "images/artifacts/necklace.png"},
                {name: "Черное сердце", price: 5900.0, image: "images/artifacts/black_heart.png"},
                {name: "Кластер", price: 2125.0, image: "images/artifacts/cluster.png"},
                {name: "Полярная звезда", price: 2222.0, image: "images/artifacts/polar_star.png"},
                {name: "Сгусток", price: 1750.0, image: "images/artifacts/clot.png"},
                {name: "Шишка", price: 8708.0, image: "images/artifacts/cone.png"},
                {name: "Дух", price: 4897.0, image: "images/artifacts/spirit.png"},
                {name: "Морской конёк", price: 2970.0, image: "images/artifacts/seahorse.png"},
                {name: "Селен", price: 5124.0, image: "images/artifacts/selenium.png"},
                {name: "Сердце", price: 2514.0, image: "images/artifacts/heart.png"},
                {name: "Пена", price: 2760.0, image: "images/artifacts/foam.png"},
                {name: "Кладофора", price: 12467.0, image: "images/artifacts/cladophora.png"},
                {name: "Петля", price: 5228.0, image: "images/artifacts/loop.png"},
                {name: "Выверт", price: 1750.0, image: "images/artifacts/twist.png"},
                {name: "Ночная звезда", price: 3950.0, image: "images/artifacts/night_star.png"},
                {name: "Улей", price: 1760.0, image: "images/artifacts/hive.png"},
                {name: "Черная медуза", price: 4050.0, image: "images/artifacts/black_jellyfish.png"},
                {name: "Креветка", price: 1000.0, image: "images/artifacts/shrimp.png"},
                {name: "Каштан", price: 1750.0, image: "images/artifacts/chestnut.png"},
                {name: "Тромб", price: 2707.0, image: "images/artifacts/thrombus.png"},
                {name: "Чертополох", price: 1055.0, image: "images/artifacts/thistle.png"},
                {name: "Котел", price: 4050.0, image: "images/artifacts/cauldron.png"},
                {name: "Лишайник", price: 875.0, image: "images/artifacts/lichen.png"},
                {name: "Упырь", price: 4050.0, image: "images/artifacts/ghoul.png"},
                {name: "Криль", price: 9198.0, image: "images/artifacts/krill.png"},
                {name: "Золотая рыбка", price: 3656.0, image: "images/artifacts/goldfish.png"},
                {name: "Хлорофилл", price: 2000.0, image: "images/artifacts/chlorophyll.png"},
                {name: "Минерал", price: 2980.0, image: "images/artifacts/mineral.png"},
                {name: "Взор", price: 3208.0, image: "images/artifacts/gaze.png"},
                {name: "Бакелит", price: 1150.0, image: "images/artifacts/bakelite.png"},
                {name: "Окаменелость", price: 1870.0, image: "images/artifacts/fossil.png"},
                {name: "Лоза", price: 980.0, image: "images/artifacts/vine.png"},
                {name: "Нейрон", price: 6905.0, image: "images/artifacts/neuron.png"},
                {name: "Вулкан", price: 4055.0, image: "images/artifacts/volcano.png"},
                {name: "Протуберанец", price: 7890.0, image: "images/artifacts/protuberance.png"},
                {name: "Валет", price: 8780.0, image: "images/artifacts/jack.png"},
                {name: "Ржавь", price: 4987.0, image: "images/artifacts/rust.png"},
                {name: "Череп", price: 6072.0, image: "images/artifacts/skull.png"},
                {name: "Снежинка", price: 2700.0, image: "images/artifacts/snowflake.png"},
                {name: "Сплав", price: 5345.0, image: "images/artifacts/alloy.png"},
                {name: "Хрусталь", price: 618.0, image: "images/artifacts/crystal_clear.png"},
                {name: "Рубин", price: 6124.0, image: "images/artifacts/ruby.png"},
                {name: "Нимб", price: 800.0, image: "images/artifacts/halo.png"},
                {name: "Кольцо", price: 11765.0, image: "images/artifacts/ring.png"},
                {name: "Батавские слезки", price: 8964.0, image: "images/artifacts/batavian_tears.png"},
                {name: "Уроробос", price: 9150.0, image: "images/artifacts/ouroboros.png"}
            ],
            garbage: [
                {name: "Руководство по выживанию", price: 70.0, image: "images/garbage/detection_guide.png"},
                {name: "Журнал 'Основы проектирования патронов'", price: 26.0, image: "images/garbage/ammo_design_journal.png"},
                {name: "Старая флага", price: 50.0, image: "images/garbage/flag_operation.png"},
                {name: "Растроенная балалайка", price: 50.0, image: "images/garbage/balalaika.png"},
                {name: "Старая гармошка", price: 150.0, image: "images/garbage/harmonic_operation.png"},
                {name: "Бумага", price: 40.0, image: "images/garbage/paper.png"},
                {name: "Бутылка керосина", price: 45.0, image: "images/garbage/kerosene.png"},
                {name: "Отсыревшие патроны 45 АСР", price: 40.0, image: "images/garbage/wet_45_acp.png"},
                {name: "Отсыревшие патроны 12 каллибра", price: 40.0, image: "images/garbage/wet_12_gauge.png"},
                {name: "Отсыревшие патроны 9х18", price: 15.0, image: "images/garbage/wet_9x18.png"},
				{name: "Отсыревшие патроны 5.56x45", price: 20.0, image: "images/garbage/wet_5.56x45.png"},
				{name: "Отсыревшие патроны 7.62x25", price: 15.0, image: "images/garbage/wet_762x25.png"},
                {name: "Порванный технический журнал", price: 45.0, image: "images/garbage/technical_journal.png"},
                {name: "Мотоциклетные очки", price: 70.0, image: "images/garbage/glasses.png"},
                {name: "Шахматная доска", price: 40.0, image: "images/garbage/chess_board.png"},
                {name: "Личное фото девушки", price: 160.0, image: "images/garbage/girl_photo.png"},
                {name: "Сверток старых газет", price: 10.0, image: "images/garbage/newspaper_bundle.png"},
                {name: "Старая газета", price: 10.0, image: "images/garbage/newspaper_operation.png"},
                {name: "Старые сапоги", price: 30.0, image: "images/garbage/boots.png"},
                {name: "Ржавая зажигалка", price: 30.0, image: "images/garbage/rusty_lighter.png"},
                {name: "Карты", price: 10.0, image: "images/garbage/cards.png"},
                {name: "Серебряное ожерелье", price: 325.0, image: "images/garbage/silver_necklace.png"},
                {name: "Канистра бензина", price: 125.0, image: "images/garbage/belkin_canister.png"},
                {name: "Журнал Maxim", price: 125.0, image: "images/garbage/maxim_magazine.png"},
                {name: "Журнал Playboy", price: 75.0, image: "images/garbage/playboy_magazine.png"},
                {name: "Спальник", price: 25.0, image: "images/garbage/sleeping_bag.png"},
				{name: "Медаль 'За отвагу'", price: 600.0, image: "images/garbage/medal_courage.png"},
				{name: "Орден Ленина", price: 1500.0, image: "images/garbage/order_lenin.png"},
				{name: "Орден славы", price: 1500.0, image: "images/garbage/order_glory.png"},
				{name: "Орден отечественной войны", price: 800.0, image: "images/garbage/order_patriotic_war.png"},
				{name: "Потёртая звезда на ленте", price: 350.0, image: "images/garbage/worn_star.png"},
				{name: "Значок НКВД", price: 800.0, image: "images/garbage/nkvd_badge.png"},
				{name: "Медаль 'За заслуги'", price: 250.0, image: "images/garbage/medal_merit.png"},
				{name: "Значок 'Снайпер'", price: 800.0, image: "images/garbage/sniper_badge.png"},
				{name: "Газовая плитка", price: 25.0, image: "images/garbage/gas_stove.png"}
            ],
            medicine: [
                {name: "Неочищенная бутылка воды", price: 30.0, image: "images/medicine/water_bottle.png"},
                {name: "Акватабс", price: 75.0, image: "images/medicine/aquatabs.png"},
                {name: "Мешок с крупой", price: 85.0, image: "images/medicine/grain_bag.png"},
                {name: "Пачка Сахара", price: 105.0, image: "images/medicine/sugar_pack.png"},
                {name: "Короб с чаем", price: 50.0, image: "images/medicine/tea_box.png"},
                {name: "Банка со специями", price: 75.0, image: "images/medicine/spices_jar.png"},
                {name: "Масло для готовки", price: 75.0, image: "images/medicine/cooking_oil.png"},
                {name: "Мясо слепого пса", price: 15.0, image: "images/medicine/blind_dog_meat.png"},
                {name: "Банка соли", price: 40.0, image: "images/medicine/salt_jar.png"},
                {name: "Гороховое пюре", price: 40.0, image: "images/medicine/pea_puree.png"},
                {name: "Аптечка", price: 100.0, image: "images/medicine/medkit.png"},
                {name: "Старый бинт", price: 75.0, image: "images/medicine/old_bandage.png"},
                {name: "Викасол", price: 80.0, image: "images/medicine/vikasol.png"},
                {name: "Пустой блистер", price: 80.0, image: "images/medicine/empty_blister.png"},
                {name: "Ацизол", price: 80.0, image: "images/medicine/atsizol.png"},
                {name: "Пакет с кровью", price: 100.0, image: "images/medicine/blood_pack.png"},
                {name: "Пустой шприц", price: 50.0, image: "images/medicine/empty_syringe.png"},
                {name: "Пустой пакет с кровью", price: 50.0, image: "images/medicine/empty_blood_pack.png"},
                {name: "Антисептик", price: 65.0, image: "images/medicine/antiseptic.png"},
                {name: "Армейское обезболивающее", price: 95.0, image: "images/medicine/army_painkiller.png"},
                {name: "Инъекция морфина", price: 120.0, image: "images/medicine/morphine_injection.png"},
                {name: "Препарат E-190", price: 195.0, image: "images/medicine/e190_drug.png"}
            ]
        };

        let selectedItems = {};
        let currentCategory = 'scrap';
        let currentDetailItem = null;
        let bonusApplied = false;
        let saleApplied = false;
        let currentSearch = '';
        let currentFilteredItems = [];
        let isSidebarOpen = false;
        let editMode = false;

        const API_URL = 'https://jsonblob.com/api/jsonBlob';

        let loans = [];
        let storageRentals = [];
        let lockedItems = {};
        let customPrices = {};
        let currentCreditCalculation = null;
        let currentStorageCalculation = null;
        let selectedCells = new Set();
        let selectedCellsEdit = new Set();
        let editingStorageId = null;
        let currentSafe = 1;

        let dataId = '';

        async function loadData() {
            try {
                const response = await fetch(`${API_URL}/1309293260908601344`);
                const data = await response.json();
                
                loans = data.loans || [];
                storageRentals = data.storageRentals || [];
                lockedItems = data.lockedItems || {};
                customPrices = data.customPrices || {};
                
                updateLoansTable();
                updateStorageTable();
                createStorageGrid();
                loadCategory(currentCategory);
            } catch (error) {
                console.log('Не удалось загрузить данные, используем локальные');
                loans = JSON.parse(localStorage.getItem('mz_loans')) || [];
                storageRentals = JSON.parse(localStorage.getItem('mz_storage_rentals')) || [];
                lockedItems = JSON.parse(localStorage.getItem('mz_locked_items')) || {};
                customPrices = JSON.parse(localStorage.getItem('mz_custom_prices')) || {};
            }
        }

        async function saveData() {
            const data = {
                loans,
                storageRentals,
                lockedItems,
                customPrices
            };

            try {
                if (!dataId) {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });
                    const location = response.headers.get('Location');
                    if (location) {
                        dataId = location.split('/').pop();
                    }
                } else {
                    await fetch(`${API_URL}/${dataId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });
                }
            } catch (error) {
                console.log('Не удалось сохранить данные в облако, сохраняем локально');
                localStorage.setItem('mz_loans', JSON.stringify(loans));
                localStorage.setItem('mz_storage_rentals', JSON.stringify(storageRentals));
                localStorage.setItem('mz_locked_items', JSON.stringify(lockedItems));
                localStorage.setItem('mz_custom_prices', JSON.stringify(customPrices));
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            loadData();
            setupEventListeners();
            updateTotal();
            updateSelectedItemsList();
            initializePages();
        }

        function setupEventListeners() {
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchCategory(this.dataset.category);
                });
            });
            
            document.getElementById('searchInput').addEventListener('input', function(e) {
                handleSearch(e.target.value);
            });

            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    switchPage(this.dataset.page);
                });
            });

            document.querySelectorAll('.safe-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    switchSafe(parseInt(this.dataset.safe));
                });
            });
        }

        function handleSearch(query) {
            currentSearch = query.toLowerCase().trim();
            
            if (currentSearch === 'карусель') {
                showSpecialMessage();
                return;
            }
            
            if (currentSearch === '1234098756') {
                toggleEditMode();
                document.getElementById('searchInput').value = '';
                currentSearch = '';
                loadCategory(currentCategory);
                return;
            }
            
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.remove('highlighted');
            });
            
            if (currentSearch === '') {
                loadCategory(currentCategory);
                return;
            }
            
            let foundCategory = null;
            
            for (const category in itemsDatabase) {
                const hasMatch = itemsDatabase[category].some(item => 
                    item.name.toLowerCase().includes(currentSearch)
                );
                
                if (hasMatch) {
                    document.querySelector(`[data-category="${category}"]`).classList.add('highlighted');
                    
                    if (category === currentCategory) {
                        foundCategory = category;
                    }
                    else if (!foundCategory) {
                        foundCategory = category;
                    }
                }
            }
            
            if (foundCategory) {
                if (foundCategory !== currentCategory) {
                    switchCategory(foundCategory);
                } else {
                    loadCategory(currentCategory);
                }
            } else {
                loadCategory(currentCategory);
            }
        }

        function toggleEditMode() {
            editMode = !editMode;
            const editControls = document.querySelector('.edit-controls');
            
            if (editMode) {
                editControls.classList.add('active');
                showNotification('Режим редактирования активирован', 'success');
            } else {
                editControls.classList.remove('active');
                showNotification('Режим редактирования деактивирован', 'info');
            }
            
            loadCategory(currentCategory);
        }

        async function toggleItemLock(itemId) {
            if (!editMode) return;
            
            lockedItems[itemId] = !lockedItems[itemId];
            
            if (lockedItems[itemId]) {
                selectedItems[itemId] = 0;
            }
            
            loadCategory(currentCategory);
            updateTotal();
            updateSelectedCount();
            updateSelectedItemsList();
            
            await saveData();
            
            const [category, index] = itemId.split('_');
            const item = itemsDatabase[category][parseInt(index)];
            const action = lockedItems[itemId] ? 'заблокирован' : 'разблокирован';
            showNotification(`Предмет "${item.name}" ${action}`, lockedItems[itemId] ? 'warning' : 'success');
        }

        async function editItemPrice(itemId) {
            if (!editMode) return;
            
            const [category, index] = itemId.split('_');
            const item = itemsDatabase[category][parseInt(index)];
            const currentPrice = customPrices[itemId] || item.price;
            
            const newPrice = prompt(`Введите новую цену для "${item.name}":`, currentPrice);
            if (newPrice === null) return;
            
            const price = parseFloat(newPrice);
            if (isNaN(price) || price < 0) {
                showNotification('Некорректная цена', 'error');
                return;
            }
            
            customPrices[itemId] = price;
            
            loadCategory(currentCategory);
            await saveData();
            showNotification(`Цена для "${item.name}" изменена на ${formatPrice(price)} руб.`, 'success');
        }

        async function resetItemPrice(itemId) {
            if (!editMode) return;
            
            const [category, index] = itemId.split('_');
            const item = itemsDatabase[category][parseInt(index)];
            
            delete customPrices[itemId];
            
            loadCategory(currentCategory);
            await saveData();
            showNotification(`Цена для "${item.name}" сброшена до стандартной`, 'info');
        }

        function getItemPrice(itemId) {
            if (customPrices[itemId] !== undefined) {
                return customPrices[itemId];
            }
            
            const [category, index] = itemId.split('_');
            return itemsDatabase[category][parseInt(index)].price;
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : type === 'warning' ? '#FF9800' : '#2196F3'};
                color: white;
                padding: 15px 20px;
                border-radius: 5px;
                z-index: 10000;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                max-width: 300px;
                word-wrap: break-word;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    document.body.removeChild(notification);
                }
            }, 3000);
        }

        function loadCategory(category) {
            const container = document.getElementById('itemsContainer');
            container.innerHTML = '';

            let items = itemsDatabase[category];
            
            currentFilteredItems = [];
            
            if (currentSearch) {
                items = items.filter((item, index) => {
                    const matches = item.name.toLowerCase().includes(currentSearch);
                    if (matches) {
                        currentFilteredItems.push({item, originalIndex: index});
                    }
                    return matches;
                });
            } else {
                items.forEach((item, index) => {
                    currentFilteredItems.push({item, originalIndex: index});
                });
            }

            currentFilteredItems.forEach((filteredItem, displayIndex) => {
                const {item, originalIndex} = filteredItem;
                const itemId = `${category}_${originalIndex}`;
                const quantity = selectedItems[itemId] || 0;
                const isLocked = lockedItems[itemId];
                const itemPrice = getItemPrice(itemId);
                
                const itemElement = document.createElement('div');
                itemElement.className = `item-card ${quantity > 0 ? 'selected' : ''} ${currentSearch && item.name.toLowerCase().includes(currentSearch) ? 'search-match' : ''} ${isLocked ? 'locked' : ''}`;
                itemElement.setAttribute('data-item', itemId);
                
                let lockButton = '';
                let priceEditButton = '';
                
                if (editMode) {
                    lockButton = `<button class="quantity-btn" onclick="toggleItemLock('${itemId}')" style="margin-top: 5px; width: 100%; background: ${isLocked ? '#5a2a2a' : '#2a5a2a'}; border-color: ${isLocked ? '#7a3a3a' : '#3a7a3a'}; color: ${isLocked ? '#ff6b6b' : '#6bff6b'};">${isLocked ? '🔓 Разблок.' : '🔒 Блок.'}</button>`;
                    priceEditButton = `<button class="quantity-btn" onclick="editItemPrice('${itemId}')" style="margin-top: 5px; width: 100%; background: #2a4a5a; border-color: #3a6a7a; color: #a0d0ff;">✏️ Цена</button>`;
                }
                
                if (isLocked) {
                    itemElement.innerHTML = `<div class="lock-indicator">🔒</div>`;
                }
                
                itemElement.innerHTML += `
                    <div class="item-image">
                        <img src="${item.image}" alt="${item.name}" 
                             onerror="handleImageError(this)">
                    </div>
                    <div class="item-name">${item.name}</div>
                    <div class="item-price">${formatPrice(itemPrice)} руб.</div>
                    <div class="quantity-controls">
                        <button class="quantity-btn" onclick="changeQuantity('${itemId}', -1)" ${isLocked ? 'disabled style="opacity: 0.5;"' : ''}>-</button>
                        <input type="number" class="quantity-input" value="${quantity}" min="0" max="200"
                               onchange="setQuantity('${itemId}', this.value)" 
                               oninput="validateNumber(this)" ${isLocked ? 'disabled style="background: #5a2a2a; color: #ff6b6b;"' : ''}>
                        <button class="quantity-btn" onclick="changeQuantity('${itemId}', 1)" ${isLocked ? 'disabled style="opacity: 0.5;"' : ''}>+</button>
                    </div>
                    ${lockButton}
                    ${priceEditButton}
                `;
                
                itemElement.addEventListener('click', function(e) {
                    if (!e.target.classList.contains('quantity-btn') && !e.target.classList.contains('quantity-input')) {
                        showItemDetails(itemId, item);
                    }
                });
                
                container.appendChild(itemElement);
            });
            
            if (currentSearch && currentFilteredItems.length === 0) {
                container.innerHTML = `<div style="text-align: center; color: var(--text-secondary); padding: 40px; grid-column: 1 / -1;">Не найдено предметов по запросу "${currentSearch}"</div>`;
            }
        }

        function handleImageError(img) {
            img.style.display = 'none';
            img.parentNode.innerHTML = '<div style="color: #666; text-align: center; padding: 10px; font-size: 0.8em;">📦<br>Нет изображения</div>';
        }

        function showItemDetails(itemId, item) {
            currentDetailItem = itemId;
            const quantity = selectedItems[itemId] || 0;
            const itemPrice = getItemPrice(itemId);
            const total = itemPrice * quantity;
            
            document.getElementById('detailName').textContent = item.name;
            document.getElementById('detailPrice').textContent = `Цена: ${formatPrice(itemPrice)} руб.`;
            document.getElementById('detailTotal').textContent = `Сумма: ${formatPrice(total)} руб.`;
            
            const detailImage = document.getElementById('detailImage');
            detailImage.innerHTML = `<img src="${item.image}" alt="${item.name}" 
                onerror="handleDetailImageError(this)">`;
                
            if (editMode) {
                const isLocked = lockedItems[itemId];
                const editButtons = `
                    <div style="margin-top: 10px; display: flex; gap: 5px;">
                        <button class="quantity-btn" onclick="toggleItemLock('${itemId}')" style="flex: 1; background: ${isLocked ? '#5a2a2a' : '#2a5a2a'}; border-color: ${isLocked ? '#7a3a3a' : '#3a7a3a'}; color: ${isLocked ? '#ff6b6b' : '#6bff6b'};">${isLocked ? '🔓 Разблок.' : '🔒 Блок.'}</button>
                        <button class="quantity-btn" onclick="editItemPrice('${itemId}')" style="flex: 1; background: #2a4a5a; border-color: #3a6a7a; color: #a0d0ff;">✏️ Цена</button>
                        ${customPrices[itemId] ? `<button class="quantity-btn" onclick="resetItemPrice('${itemId}')" style="flex: 1; background: #5a4a2a; border-color: #7a6a3a; color: #ffd06b;">🗑️ Сброс цены</button>` : ''}
                    </div>
                `;
                detailImage.insertAdjacentHTML('afterend', editButtons);
            }
        }

        function handleDetailImageError(img) {
            img.style.display = 'none';
            detailImage.innerHTML = '<div style="color: #666; text-align: center; padding: 20px; font-size: 0.8em;">📦<br>Изображение<br>недоступно</div>';
        }

        function changeQuantity(itemId, delta) {
            if (lockedItems[itemId]) {
                showNotification('Этот предмет заблокирован', 'error');
                return;
            }
            
            const currentQuantity = selectedItems[itemId] || 0;
            const newQuantity = Math.max(0, Math.min(200, currentQuantity + delta));
            setQuantity(itemId, newQuantity);
        }

        function setQuantity(itemId, quantity) {
            if (lockedItems[itemId]) {
                showNotification('Этот предмет заблокирован', 'error');
                return;
            }
            
            quantity = parseInt(quantity) || 0;
            quantity = Math.min(200, Math.max(0, quantity));
            selectedItems[itemId] = quantity;
            
            updateItemDisplay(itemId, quantity);
            updateTotal();
            updateSelectedCount();
            updateSelectedItemsList();
            
            if (currentDetailItem === itemId) {
                const [category, index] = itemId.split('_');
                const item = itemsDatabase[category][parseInt(index)];
                showItemDetails(itemId, item);
            }
        }

        function validateNumber(input) {
            let value = input.value.replace(/[^0-9]/g, '');
            if (value === '') value = '0';
            value = Math.min(200, parseInt(value) || 0);
            input.value = value;
        }

        function updateItemDisplay(itemId, quantity) {
            const itemElement = document.querySelector(`[data-item="${itemId}"]`);
            if (!itemElement) return;
            
            const input = itemElement.querySelector('.quantity-input');
            input.value = quantity;
            
            if (quantity > 0) {
                itemElement.classList.add('selected');
            } else {
                itemElement.classList.remove('selected');
            }
        }

        function updateTotal() {
            let total = 0;
            
            for (const [itemId, quantity] of Object.entries(selectedItems)) {
                if (quantity > 0) {
                    const itemPrice = getItemPrice(itemId);
                    total += itemPrice * quantity;
                }
            }
            
            if (bonusApplied) {
                const bonusTotal = total * 1.15;
                document.getElementById('totalSum').textContent = formatPrice(total);
                document.getElementById('bonusSum').textContent = `+15%: ${formatPrice(bonusTotal)}`;
                document.getElementById('bonusSum').style.display = 'block';
                document.getElementById('saleSum').style.display = 'none';
            } else if (saleApplied) {
                const saleTotal = total * 1.30;
                document.getElementById('totalSum').textContent = formatPrice(total);
                document.getElementById('saleSum').textContent = `+30%: ${formatPrice(saleTotal)}`;
                document.getElementById('saleSum').style.display = 'block';
                document.getElementById('bonusSum').style.display = 'none';
            } else {
                document.getElementById('totalSum').textContent = formatPrice(total);
                document.getElementById('bonusSum').style.display = 'none';
                document.getElementById('saleSum').style.display = 'none';
            }
        }

        function updateSelectedCount() {
            let count = 0;
            for (const quantity of Object.values(selectedItems)) {
                if (quantity > 0) count++;
            }
            document.getElementById('selectedCount').textContent = `Выбрано предметов: ${count}`;
        }

        function updateSelectedItemsList() {
            const container = document.getElementById('selectedItemsList');
            
            let hasItems = false;
            let itemsHTML = '';
            
            for (const [itemId, quantity] of Object.entries(selectedItems)) {
                if (quantity > 0) {
                    hasItems = true;
                    const [category, index] = itemId.split('_');
                    const item = itemsDatabase[category][parseInt(index)];
                    const itemPrice = getItemPrice(itemId);
                    const total = itemPrice * quantity;
                    
                    itemsHTML += `
                        <div class="selected-item" data-item="${itemId}">
                            <div class="selected-item-info">
                                <div class="selected-item-name">${item.name}</div>
                                <div class="selected-item-price">${formatPrice(itemPrice)} руб. ×</div>
                            </div>
                            <div class="selected-item-quantity">
                                <button class="quantity-btn" onclick="changeQuantity('${itemId}', -1)">-</button>
                                <span class="selected-item-qty">${quantity}</span>
                                <button class="quantity-btn" onclick="changeQuantity('${itemId}', 1)">+</button>
                                <button class="remove-item-btn" onclick="setQuantity('${itemId}', 0)" title="Удалить">×</button>
                            </div>
                            <div class="selected-item-total">${formatPrice(total)}</div>
                        </div>
                    `;
                }
            }
            
            if (hasItems) {
                container.innerHTML = itemsHTML;
            } else {
                container.innerHTML = '<div class="empty-selected">Нет выбранных предметов</div>';
            }
        }

        function formatPrice(price) {
            return new Intl.NumberFormat('ru-RU', {
                minimumFractionDigits: 1,
                maximumFractionDigits: 1
            }).format(price);
        }

        function calculateTotal() {
            let total = 0;
            for (const [itemId, quantity] of Object.entries(selectedItems)) {
                if (quantity > 0) {
                    const itemPrice = getItemPrice(itemId);
                    total += itemPrice * quantity;
                }
            }
            return total;
        }

        function resetAll() {
            const currentTotal = calculateTotal();
            
            selectedItems = {};
            bonusApplied = false;
            saleApplied = false;
            currentSearch = '';
            document.getElementById('searchInput').value = '';
            loadCategory(currentCategory);
            updateTotal();
            updateSelectedCount();
            updateSelectedItemsList();
            
            document.getElementById('detailName').textContent = '-';
            document.getElementById('detailPrice').textContent = 'Цена: -';
            document.getElementById('detailTotal').textContent = 'Сумма: -';
            document.getElementById('detailImage').innerHTML = '<div style="color: #666; text-align: center; font-size: 0.9em;">Выберите предмет</div>';
            
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.remove('highlighted');
            });
            
            playResetSound(currentTotal);
        }
        
        function playResetSound(total) {
            const audio = new Audio();
            
            audio.volume = 0.1;
            
            if (total < 1000) {
                audio.src = 'sounds/low_money.mp3';
            } else if (total > 50000) {
                audio.src = 'sounds/high_money.mp3';
            } else {
                return;
            }
            
            audio.play().catch(error => {
                console.log('Не удалось воспроизвести звук:', error);
            });
        }

        function addBonus() {
            bonusApplied = !bonusApplied;
            saleApplied = false;
            updateTotal();
        }

        function addSale() {
            saleApplied = !saleApplied;
            bonusApplied = false;
            updateTotal();
        }

        function downloadList() {
            let hasItems = false;
            let fileContent = "СПИСОК ПРЕДМЕТОВ ДЛЯ СКУПКИ МЗ\n";
            fileContent += "================================\n";
            fileContent += `Сгенерировано: ${new Date().toLocaleString('ru-RU')}\n`;
            fileContent += "================================\n\n";
            
            const categories = {
                scrap: "ХЛАМ",
                garbage: "МУСОР", 
                medicine: "ИНГРИДИЕНТЫ",
                mutants: "МУТАНТЫ",
                documents: "ДОКУМЕНТЫ",
                artifacts: "АРТЕФАКТЫ"
            };
            
            let totalItems = 0;
            let totalValue = 0;
            
            for (const categoryKey in categories) {
                let categoryHasItems = false;
                let categoryContent = "";
                let categoryTotal = 0;
                let categoryCount = 0;
                
                for (const [itemId, quantity] of Object.entries(selectedItems)) {
                    if (quantity > 0 && itemId.startsWith(categoryKey + '_')) {
                        const [category, index] = itemId.split('_');
                        const item = itemsDatabase[category][parseInt(index)];
                        const itemPrice = getItemPrice(itemId);
                        
                        categoryContent += `  ${item.name} - ${quantity} шт.\n`;
                        categoryTotal += itemPrice * quantity;
                        categoryCount += quantity;
                        totalItems += quantity;
                        totalValue += itemPrice * quantity;
                        categoryHasItems = true;
                        hasItems = true;
                    }
                }
                
                if (categoryHasItems) {
                    fileContent += `${categories[categoryKey]}:\n`;
                    fileContent += categoryContent;
                    fileContent += `  Итого по категории: ${categoryCount} шт. / ${formatPrice(categoryTotal)} руб.\n\n`;
                }
            }
            
            if (!hasItems) {
                fileContent += "Нет выбранных предметов.\n";
            } else {
                fileContent += "================================\n";
                fileContent += `ОБЩИЙ ИТОГ: ${totalItems} предметов\n`;
                fileContent += `СУММА: ${formatPrice(totalValue)} руб.\n`;
                
                if (bonusApplied) {
                    const bonusTotal = totalValue * 1.15;
                    fileContent += `С БОНУСОМ 15%: ${formatPrice(bonusTotal)} руб.\n`;
                } else if (saleApplied) {
                    const saleTotal = totalValue * 1.30;
                    fileContent += `С ПРОДАЖЕЙ 30%: ${formatPrice(saleTotal)} руб.\n`;
                }
                
                fileContent += "================================\n";
            }
            
            fileContent += "\nСгенерировано калькулятором скупки МЗ";
            
            const blob = new Blob([fileContent], { type: 'text/plain; charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            const now = new Date();
            const dateString = now.toLocaleDateString('ru-RU').replace(/\./g, '-');
            const timeString = now.toLocaleTimeString('ru-RU').replace(/:/g, '-');
            
            a.href = url;
            a.download = `МЗ_заказ_${dateString}_${timeString}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showDownloadFeedback();
        }

        function showDownloadFeedback() {
            const btn = document.querySelector('.control-btn.download');
            const originalText = btn.innerHTML;
            
            btn.innerHTML = '✅ Скачано!';
            btn.style.background = '#2a5a2a';
            btn.style.borderColor = '#3a7a3a';
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.style.background = '';
                btn.style.borderColor = '';
            }, 2000);
        }

        function showSpecialMessage() {
            const overlay = document.createElement('div');
            overlay.className = 'overlay';
            
            const message = document.createElement('div');
            message.className = 'special-message';
            message.innerHTML = `
                <h2>Это создатель этого калькулятора.</h2>
                <p>Молодец, ты знаешь кто это сделал.</p>
                <p class="ps">P.s. А зачем ты вообще написал мой позывной?</p>
                <button class="close-message">Закрыть</button>
            `;
            
            document.body.appendChild(overlay);
            document.body.appendChild(message);
            
            document.querySelector('.close-message').addEventListener('click', function() {
                document.body.removeChild(overlay);
                document.body.removeChild(message);
                document.getElementById('searchInput').value = '';
                currentSearch = '';
                loadCategory(currentCategory);
            });
        }

        function switchCategory(category) {
            currentCategory = category;
            
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-category="${category}"]`).classList.add('active');
            
            loadCategory(category);
        }

        function toggleItemsSidebar() {
            const sidebar = document.getElementById('itemsSidebar');
            const appContainer = document.getElementById('appContainer');
            isSidebarOpen = !isSidebarOpen;
            
            if (isSidebarOpen) {
                sidebar.classList.add('open');
                appContainer.classList.add('sidebar-open');
                updateSelectedItemsList();
            } else {
                sidebar.classList.remove('open');
                appContainer.classList.remove('sidebar-open');
            }
        }

        function initializePages() {
            switchPage('calculator');
            createStorageGrid();
            updateLoansTable();
            updateStorageTable();
        }

        function switchPage(pageName) {
            document.querySelectorAll('.app-page').forEach(page => {
                page.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(pageName + 'Page').classList.add('active');
            
            document.querySelector(`[data-page="${pageName}"]`).classList.add('active');
        }

        function calculateCredit() {
            const playerName = document.getElementById('creditPlayerName').value;
            const uid = document.getElementById('creditUID').value;
            const amount = parseFloat(document.getElementById('creditAmount').value);
            const days = parseInt(document.getElementById('creditDays').value);
            
            if (!playerName || !uid || !amount || !days) {
                alert('Заполните все поля!');
                return;
            }
            
            let total = amount;
            let breakdown = [];
            
            for (let day = 1; day <= days; day++) {
                let dailyRate;
                if (day <= 5) {
                    dailyRate = 0.08;
                } else if (day <= 10) {
                    dailyRate = 0.04;
                } else {
                    dailyRate = 0.02;
                }
                
                const dailyIncrease = total * dailyRate;
                total += dailyIncrease;
                
                breakdown.push({
                    day: day,
                    rate: (dailyRate * 100) + '%',
                    increase: dailyIncrease,
                    total: total
                });
            }
            
            currentCreditCalculation = {
                playerName,
                uid,
                amount,
                days,
                total: total,
                breakdown
            };
            
            document.getElementById('creditResult').style.display = 'block';
            document.getElementById('creditTotal').textContent = formatPrice(total) + ' руб.';
            
            let breakdownHTML = '<div style="margin-top: 10px; font-size: 0.9em; color: var(--text-secondary);">';
            breakdownHTML += `<div>Начальная сумма: ${formatPrice(amount)} руб.</div>`;
            breakdownHTML += `<div>Итоговая сумма: ${formatPrice(total)} руб.</div>`;
            breakdownHTML += `<div>Переплата: ${formatPrice(total - amount)} руб.</div>`;
            breakdownHTML += '</div>';
            
            document.getElementById('creditBreakdown').innerHTML = breakdownHTML;
        }

        async function createLoan() {
            if (!currentCreditCalculation) {
                alert('Сначала рассчитайте кредит!');
                return;
            }
            
            const loan = {
                id: Date.now(),
                ...currentCreditCalculation,
                startDate: new Date().toLocaleDateString('ru-RU'),
            };
            
            loans.push(loan);
            await saveData();
            updateLoansTable();
            
            document.getElementById('creditPlayerName').value = '';
            document.getElementById('creditUID').value = '';
            document.getElementById('creditAmount').value = '';
            document.getElementById('creditDays').value = '';
            document.getElementById('creditResult').style.display = 'none';
            currentCreditCalculation = null;
            
            alert('Кредит успешно оформлен!');
        }

        function updateLoansTable() {
            const tbody = document.getElementById('loansTableBody');
            tbody.innerHTML = '';
            
            loans.forEach(loan => {
                const currentDebt = calculateCurrentDebt(loan);
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${loan.playerName}</td>
                    <td>${loan.uid}</td>
                    <td>${formatPrice(loan.amount)} руб.</td>
                    <td>${loan.days} дней</td>
                    <td>${loan.startDate}</td>
                    <td>${formatPrice(currentDebt)} руб.</td>
                    <td>
                        <button class="delete-btn" onclick="deleteLoan(${loan.id})">Удалить</button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function calculateCurrentDebt(loan) {
            return loan.total;
        }

        async function deleteLoan(loanId) {
            loans = loans.filter(loan => loan.id !== loanId);
            await saveData();
            updateLoansTable();
        }

        function switchSafe(safeNumber) {
            currentSafe = safeNumber;
            
            document.querySelectorAll('.safe-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-safe="${safeNumber}"]`).classList.add('active');
            
            document.getElementById('currentSafeName').textContent = `Сейф ${safeNumber}`;
            
            clearSelection();
            createStorageGrid();
        }

        function createStorageGrid() {
            const grid = document.getElementById('storageGrid');
            grid.innerHTML = '';
            
            for (let row = 0; row < 18; row++) {
                for (let col = 0; col < 9; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'storage-cell';
                    cell.dataset.id = `${currentSafe}-${row}-${col}`;
                    cell.addEventListener('click', () => toggleCellSelection(cell));
                    
                    const isOccupied = storageRentals.some(rental => 
                        rental.safe === currentSafe && rental.cells.includes(`${row}-${col}`)
                    );
                    
                    if (isOccupied) {
                        cell.classList.add('occupied');
                        const rental = storageRentals.find(r => r.safe === currentSafe && r.cells.includes(`${row}-${col}`));
                        cell.innerHTML = `<div class="cell-info">${rental.uid.substring(0, 5)}</div>`;
                    }
                    
                    grid.appendChild(cell);
                }
            }
        }

        function createEditStorageGrid() {
            const grid = document.getElementById('editStorageGrid');
            grid.innerHTML = '';
            
            const editingRental = storageRentals.find(r => r.id === editingStorageId);
            const editSafe = editingRental ? editingRental.safe : currentSafe;
            
            for (let row = 0; row < 18; row++) {
                for (let col = 0; col < 9; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'storage-cell';
                    cell.dataset.id = `${editSafe}-${row}-${col}`;
                    cell.addEventListener('click', () => toggleCellSelectionEdit(cell));
                    
                    const isOccupied = storageRentals.some(rental => 
                        rental.id !== editingStorageId && rental.safe === editSafe && rental.cells.includes(`${row}-${col}`)
                    );
                    
                    if (isOccupied) {
                        cell.classList.add('occupied');
                        const rental = storageRentals.find(r => r.safe === editSafe && r.cells.includes(`${row}-${col}`));
                        cell.innerHTML = `<div class="cell-info">${rental.uid.substring(0, 5)}</div>`;
                    } else if (selectedCellsEdit.has(`${row}-${col}`)) {
                        cell.classList.add('selected');
                    }
                    
                    grid.appendChild(cell);
                }
            }
        }

        function toggleCellSelection(cell) {
            if (cell.classList.contains('occupied')) {
                return;
            }
            
            const cellId = cell.dataset.id;
            
            if (selectedCells.has(cellId)) {
                selectedCells.delete(cellId);
                cell.classList.remove('selected');
            } else {
                selectedCells.add(cellId);
                cell.classList.add('selected');
            }
            
            document.getElementById('storageCellsCount').value = selectedCells.size;
        }

        function toggleCellSelectionEdit(cell) {
            if (cell.classList.contains('occupied')) {
                return;
            }
            
            const cellId = cell.dataset.id;
            
            if (selectedCellsEdit.has(cellId)) {
                selectedCellsEdit.delete(cellId);
                cell.classList.remove('selected');
            } else {
                selectedCellsEdit.add(cellId);
                cell.classList.add('selected');
            }
            
            document.getElementById('editStorageCellsCount').value = selectedCellsEdit.size;
        }

        function selectAllCells() {
            selectedCells.clear();
            document.querySelectorAll('#storageGrid .storage-cell').forEach(cell => {
                if (!cell.classList.contains('occupied')) {
                    const cellId = cell.dataset.id;
                    selectedCells.add(cellId);
                    cell.classList.add('selected');
                }
            });
            document.getElementById('storageCellsCount').value = selectedCells.size;
        }

        function selectAllCellsEdit() {
            selectedCellsEdit.clear();
            document.querySelectorAll('#editStorageGrid .storage-cell').forEach(cell => {
                if (!cell.classList.contains('occupied')) {
                    const cellId = cell.dataset.id;
                    selectedCellsEdit.add(cellId);
                    cell.classList.add('selected');
                }
            });
            document.getElementById('editStorageCellsCount').value = selectedCellsEdit.size;
        }

        function clearSelection() {
            selectedCells.clear();
            document.querySelectorAll('#storageGrid .storage-cell').forEach(cell => {
                cell.classList.remove('selected');
            });
            document.getElementById('storageCellsCount').value = 0;
        }

        function clearSelectionEdit() {
            selectedCellsEdit.clear();
            document.querySelectorAll('#editStorageGrid .storage-cell').forEach(cell => {
                cell.classList.remove('selected');
            });
            document.getElementById('editStorageCellsCount').value = 0;
        }

        function calculateStorage() {
            const playerName = document.getElementById('storagePlayerName').value;
            const uid = document.getElementById('storageUID').value;
            const days = parseInt(document.getElementById('storageDays').value);
            const cellsCount = selectedCells.size;
            
            if (!playerName || !uid || !days || cellsCount === 0) {
                alert('Заполните все поля и выберите ячейки!');
                return;
            }
            
            let pricePerCell;
            if (days <= 5) {
                pricePerCell = 750;
            } else if (days <= 10) {
                pricePerCell = 900;
            } else if (days <= 20) {
                pricePerCell = 1000;
            } else {
                pricePerCell = 1200;
            }
            
            const totalCost = cellsCount * pricePerCell;
            
            currentStorageCalculation = {
                playerName,
                uid,
                days,
                safe: currentSafe,
                cells: Array.from(selectedCells).map(cell => cell.split('-').slice(1).join('-')),
                cellsCount,
                pricePerCell,
                totalCost
            };
            
            document.getElementById('storageResult').style.display = 'block';
            document.getElementById('storageTotal').textContent = formatPrice(totalCost) + ' руб.';
            
            let breakdownHTML = `
                <div style="margin-top: 10px; font-size: 0.9em; color: var(--text-secondary);">
                    <div>Сейф: ${currentSafe}</div>
                    <div>Количество ячеек: ${cellsCount}</div>
                    <div>Цена за ячейку: ${formatPrice(pricePerCell)} руб.</div>
                    <div>Срок: ${days} дней</div>
                    <div>Общая стоимость: ${formatPrice(totalCost)} руб.</div>
                </div>
            `;
            
            document.getElementById('storageBreakdown').innerHTML = breakdownHTML;
        }

        async function createStorageRental() {
            if (!currentStorageCalculation) {
                alert('Сначала рассчитайте стоимость!');
                return;
            }
            
            const rental = {
                id: Date.now(),
                ...currentStorageCalculation,
                startDate: new Date().toLocaleDateString('ru-RU'),
                color: getRandomColor()
            };
            
            storageRentals.push(rental);
            await saveData();
            updateStorageTable();
            createStorageGrid();
            
            document.getElementById('storagePlayerName').value = '';
            document.getElementById('storageUID').value = '';
            document.getElementById('storageDays').value = '';
            document.getElementById('storageResult').style.display = 'none';
            clearSelection();
            currentStorageCalculation = null;
            
            alert('Аренда хранилища успешно оформлена!');
        }

        function editStorageRental(rentalId) {
            const rental = storageRentals.find(r => r.id === rentalId);
            if (!rental) return;
            
            editingStorageId = rentalId;
            
            document.getElementById('editStoragePlayerName').value = rental.playerName;
            document.getElementById('editStorageUID').value = rental.uid;
            document.getElementById('editStorageDays').value = rental.days;
            
            selectedCellsEdit = new Set(rental.cells.map(cell => `${rental.safe}-${cell}`));
            document.getElementById('editStorageCellsCount').value = selectedCellsEdit.size;
            
            createEditStorageGrid();
            
            document.getElementById('editStorageSection').style.display = 'block';
            
            document.getElementById('editStorageSection').scrollIntoView({ behavior: 'smooth' });
        }

        async function updateStorageRental() {
            if (!editingStorageId) return;
            
            const rentalIndex = storageRentals.findIndex(r => r.id === editingStorageId);
            if (rentalIndex === -1) return;
            
            const playerName = document.getElementById('editStoragePlayerName').value;
            const uid = document.getElementById('editStorageUID').value;
            const days = parseInt(document.getElementById('editStorageDays').value);
            const cellsCount = selectedCellsEdit.size;
            
            if (!playerName || !uid || !days || cellsCount === 0) {
                alert('Заполните все поля и выберите ячейки!');
                return;
            }
            
            let pricePerCell;
            if (days <= 5) {
                pricePerCell = 750;
            } else if (days <= 10) {
                pricePerCell = 900;
            } else if (days <= 20) {
                pricePerCell = 1000;
            } else {
                pricePerCell = 1200;
            }
            
            const totalCost = cellsCount * pricePerCell;
            
            storageRentals[rentalIndex] = {
                ...storageRentals[rentalIndex],
                playerName,
                uid,
                days,
                cells: Array.from(selectedCellsEdit).map(cell => cell.split('-').slice(1).join('-')),
                cellsCount,
                pricePerCell,
                totalCost
            };
            
            await saveData();
            updateStorageTable();
            createStorageGrid();
            cancelEditStorage();
            
            alert('Аренда хранилища успешно обновлена!');
        }

        function cancelEditStorage() {
            editingStorageId = null;
            selectedCellsEdit.clear();
            document.getElementById('editStorageSection').style.display = 'none';
        }

        function updateStorageTable() {
            const tbody = document.getElementById('storageTableBody');
            tbody.innerHTML = '';
            
            storageRentals.forEach(rental => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${rental.playerName}</td>
                    <td>${rental.uid}</td>
                    <td>${rental.days} дней</td>
                    <td>Сейф ${rental.safe} - ${rental.cellsCount} ячеек</td>
                    <td>${formatPrice(rental.totalCost)} руб.</td>
                    <td>${rental.startDate}</td>
                    <td>
                        <button class="edit-storage-btn" onclick="editStorageRental(${rental.id})">Редактировать</button>
                        <button class="delete-btn" onclick="deleteStorageRental(${rental.id})">Удалить</button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        async function deleteStorageRental(rentalId) {
            storageRentals = storageRentals.filter(rental => rental.id !== rentalId);
            await saveData();
            updateStorageTable();
            createStorageGrid();
            
            if (editingStorageId === rentalId) {
                cancelEditStorage();
            }
        }

        function getRandomColor() {
            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        async function resetAllPrices() {
            if (!editMode || !confirm('Вы уверены, что хотите сбросить ВСЕ измененные цены?')) return;
            
            customPrices = {};
            await saveData();
            loadCategory(currentCategory);
            showNotification('Все цены сброшены до стандартных', 'success');
        }

        async function unlockAllItems() {
            if (!editMode || !confirm('Вы уверены, что хотите разблокировать ВСЕ предметы?')) return;
            
            lockedItems = {};
            await saveData();
            loadCategory(currentCategory);
            showNotification('Все предметы разблокированы', 'success');
        }
    </script>
</body>
</html>